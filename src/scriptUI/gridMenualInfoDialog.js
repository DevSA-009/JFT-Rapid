/*
Code for Import https://scriptui.joonas.me â€” (Triple click to select): 
{"activeId":25,"items":{"item-0":{"id":0,"type":"Dialog","parentId":false,"style":{"enabled":true,"constName":"dialogRoot","windowType":"Dialog","creationProps":{"su1PanelCoordinates":false,"maximizeButton":false,"minimizeButton":false,"independent":false,"closeButton":true,"borderless":false,"resizeable":false},"text":"grid Body","preferredSize":[0,0],"margins":16,"orientation":"column","spacing":0,"alignChildren":["center","center"]}},"item-2":{"id":2,"type":"Panel","parentId":23,"style":{"enabled":true,"constName":"gridBody","creationProps":{"borderStyle":"etched","su1PanelCoordinates":false},"text":"Basic","preferredSize":[200,0],"margins":10,"orientation":"column","spacing":10,"alignChildren":["center","top"],"alignment":null}},"item-3":{"id":3,"type":"Group","parentId":2,"style":{"enabled":true,"constName":"modeGrp","preferredSize":[100,0],"margins":0,"orientation":"column","spacing":5,"alignChildren":["center","center"],"alignment":"center"}},"item-4":{"id":4,"type":"StaticText","parentId":3,"style":{"enabled":true,"constName":"gridMode","creationProps":{"truncate":"none","multiline":false,"scrolling":false},"softWrap":false,"text":"Mode:","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":null}},"item-5":{"id":5,"type":"DropDownList","parentId":3,"style":{"enabled":true,"constName":"gridModeList","text":"DropDownList","listItems":"A,B","preferredSize":[70,10],"alignment":"center","selection":0,"helpTip":null}},"item-6":{"id":6,"type":"Group","parentId":18,"style":{"enabled":true,"constName":"sizeContGrp","preferredSize":[100,0],"margins":0,"orientation":"column","spacing":5,"alignChildren":["center","center"],"alignment":null}},"item-7":{"id":7,"type":"StaticText","parentId":6,"style":{"enabled":true,"constName":"sizeContainer","creationProps":{"truncate":"none","multiline":false,"scrolling":false},"softWrap":false,"text":"Size Container","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":null}},"item-8":{"id":8,"type":"DropDownList","parentId":6,"style":{"enabled":true,"constName":"sizeContainerList","text":"DropDownList","listItems":"JFT,SLCV,PLS","preferredSize":[70,0],"alignment":"center","selection":0,"helpTip":null}},"item-9":{"id":9,"type":"Group","parentId":2,"style":{"enabled":true,"constName":"perDocGrp","preferredSize":[100,0],"margins":0,"orientation":"column","spacing":5,"alignChildren":["center","center"],"alignment":null}},"item-10":{"id":10,"type":"StaticText","parentId":9,"style":{"enabled":true,"constName":"perDoc","creationProps":{"truncate":"none","multiline":false,"scrolling":false},"softWrap":false,"text":"Per Document","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":null}},"item-11":{"id":11,"type":"EditText","parentId":9,"style":{"enabled":true,"constName":"perDocField","creationProps":{"noecho":false,"readonly":false,"multiline":false,"scrollable":false,"borderless":false,"enterKeySignalsOnChange":false},"softWrap":false,"text":"0","justify":"center","preferredSize":[70,0],"alignment":null,"helpTip":null}},"item-12":{"id":12,"type":"Group","parentId":18,"style":{"enabled":true,"constName":"targetSizeGrp","preferredSize":[100,0],"margins":0,"orientation":"column","spacing":5,"alignChildren":["center","center"],"alignment":null}},"item-13":{"id":13,"type":"StaticText","parentId":12,"style":{"enabled":true,"constName":"targetSize","creationProps":{"truncate":"none","multiline":false,"scrolling":false},"softWrap":false,"text":"Target Size","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":null}},"item-14":{"id":14,"type":"DropDownList","parentId":12,"style":{"enabled":true,"constName":"sizeList","text":"DropDownList","listItems":"S,M,L,XL,2XL,3XL","preferredSize":[70,0],"alignment":"center","selection":0,"helpTip":null}},"item-15":{"id":15,"type":"Group","parentId":2,"style":{"enabled":true,"constName":"itemsGap","preferredSize":[100,0],"margins":0,"orientation":"column","spacing":5,"alignChildren":["center","center"],"alignment":null}},"item-16":{"id":16,"type":"StaticText","parentId":15,"style":{"enabled":true,"constName":"itemsGap","creationProps":{"truncate":"none","multiline":false,"scrolling":false},"softWrap":false,"text":"Items Gap","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":null}},"item-17":{"id":17,"type":"EditText","parentId":15,"style":{"enabled":true,"constName":"itemsGapField","creationProps":{"noecho":false,"readonly":false,"multiline":false,"scrollable":false,"borderless":false,"enterKeySignalsOnChange":false},"softWrap":false,"text":"0.1","justify":"center","preferredSize":[70,0],"alignment":null,"helpTip":null}},"item-18":{"id":18,"type":"Panel","parentId":23,"style":{"enabled":true,"constName":"requiredPanel","creationProps":{"borderStyle":"etched","su1PanelCoordinates":false},"text":"Size & Required","preferredSize":[200,0],"margins":10,"orientation":"column","spacing":10,"alignChildren":["center","top"],"alignment":null}},"item-20":{"id":20,"type":"Group","parentId":18,"style":{"enabled":true,"constName":"quantityGrp","preferredSize":[100,0],"margins":0,"orientation":"column","spacing":5,"alignChildren":["center","center"],"alignment":null}},"item-21":{"id":21,"type":"StaticText","parentId":20,"style":{"enabled":true,"constName":"quantity","creationProps":{"truncate":"none","multiline":false,"scrolling":false},"softWrap":false,"text":"Quantity","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":null}},"item-22":{"id":22,"type":"EditText","parentId":20,"style":{"enabled":true,"constName":"quantityField","creationProps":{"noecho":false,"readonly":false,"multiline":false,"scrollable":false,"borderless":false,"enterKeySignalsOnChange":false},"softWrap":false,"text":"2","justify":"center","preferredSize":[70,0],"alignment":null,"helpTip":null}},"item-23":{"id":23,"type":"Group","parentId":0,"style":{"enabled":true,"constName":"panelContGrp","preferredSize":[0,0],"margins":[0,0,10,0],"orientation":"row","spacing":10,"alignChildren":["center","center"],"alignment":null}},"item-24":{"id":24,"type":"Group","parentId":0,"style":{"enabled":true,"constName":"enterBtnGrp","preferredSize":[0,0],"margins":0,"orientation":"row","spacing":10,"alignChildren":["left","center"],"alignment":null}},"item-25":{"id":25,"type":"Button","parentId":24,"style":{"enabled":true,"constName":"enterBn","text":"Start","justify":"center","preferredSize":[0,0],"alignment":null,"helpTip":"Start Action"}}},"order":[0,23,2,3,4,5,9,10,11,15,16,17,18,6,7,8,12,13,14,20,21,22,24,25],"settings":{"importJSON":true,"indentSize":false,"cepExport":false,"includeCSSJS":true,"showDialog":true,"functionWrapper":false,"afterEffectsDockable":false,"itemReferenceList":"none"}}
*/

// DIALOGROOT
// ==========
const gridMenualInfoDialog = () => {
    const dialogRoot = new Window("dialog");
    dialogRoot.text = "Grid Layout Body";
    dialogRoot.orientation = "column";
    dialogRoot.alignChildren = ["center", "center"];
    dialogRoot.spacing = 0;
    dialogRoot.margins = 16;

    const digitValidateCb = (event) => {
        const key = event.keyName; // Note: using 'key' instead of 'keyName' which is more standard

        if (event.keyName === "Escape") {
            dialogRoot.close();
            return;
        }

        // Allow numbers, backspace, delete, and decimal point
        // Also prevent multiple decimal points
        if (
            !/[0-9]/.test(key) &&
            key !== "Backspace" &&
            key !== "Delete"
        ) {
            event.preventDefault();
        }

        if (key === "Enter") {
            enterBn.notify()
        }
    };

    // PANELCONTGRP
    // ============
    const panelContGrp = dialogRoot.add("group", undefined, { name: "panelContGrp" });
    panelContGrp.orientation = "row";
    panelContGrp.alignChildren = ["center", "center"];
    panelContGrp.spacing = 10;
    panelContGrp.margins = [0, 0, 0, 10];

    // gridBODY
    // =======
    const gridBody = panelContGrp.add("panel", undefined, undefined, { name: "gridBody" });
    gridBody.text = "Basic";
    gridBody.preferredSize.width = 200;
    gridBody.orientation = "column";
    gridBody.alignChildren = ["center", "top"];
    gridBody.spacing = 10;
    gridBody.margins = 10;

    // MODEGRP
    // =======
    const modeGrp = gridBody.add("group", undefined, { name: "modeGrp" });
    modeGrp.preferredSize.width = 100;
    modeGrp.orientation = "column";
    modeGrp.alignChildren = ["center", "center"];
    modeGrp.spacing = 5;
    modeGrp.margins = 0;
    modeGrp.alignment = ["center", "top"];

    const gridMode = modeGrp.add("statictext", undefined, undefined, { name: "gridMode" });
    gridMode.text = "Mode:";
    gridMode.justify = "center";

    const gridModeList_array = objectKeys(GridMode);
    const gridModeList = modeGrp.add("dropdownlist", undefined, undefined, { name: "gridModeList", items: gridModeList_array });
    gridModeList.selection = 0;
    gridModeList.preferredSize.width = 70;
    gridModeList.preferredSize.height = 10;
    gridModeList.alignment = ["center", "center"];

    // ORIENTATIONGRP
    // ==============
    const orientationGrp = gridBody.add("group", undefined, { name: "orientationGrp" });
    orientationGrp.preferredSize.width = 100;
    orientationGrp.orientation = "column";
    orientationGrp.alignChildren = ["center", "center"];
    orientationGrp.spacing = 5;
    orientationGrp.margins = 0;
    orientationGrp.alignment = ["center", "top"];

    const gridOrientation = orientationGrp.add("statictext", undefined, undefined, { name: "gridOrientation" });
    gridOrientation.text = "Orientation:";
    gridOrientation.justify = "center";

    const orientations_array = ["Auto", ...objectKeys(GridOrientation)];
    const orientations = orientationGrp.add("dropdownlist", undefined, undefined, { name: "orientations", items: orientations_array });
    orientations.selection = 0;
    orientations.preferredSize.width = 70;
    orientations.preferredSize.height = 10;
    orientations.alignment = ["center", "center"]; 

    // PERDOCGRP
    // =========
    const perDocGrp = gridBody.add("group", undefined, { name: "perDocGrp" });
    perDocGrp.preferredSize.width = 100;
    perDocGrp.orientation = "column";
    perDocGrp.alignChildren = ["center", "center"];
    perDocGrp.spacing = 5;
    perDocGrp.margins = 0;

    const perDoc = perDocGrp.add("statictext", undefined, undefined, { name: "perDoc" });
    perDoc.text = "Per Doc Row";
    perDoc.justify = "center";

    const perDocField = perDocGrp.add('edittext {justify: "center", properties: {name: "perDocField"}}');
    perDocField.text = "0";
    perDocField.preferredSize.width = 70;

    perDocField.addEventListener("keydown", digitValidateCb);

    // ITEMSGAP
    // ========
    const itemsGap = gridBody.add("group", undefined, { name: "itemsGap" });
    itemsGap.preferredSize.width = 100;
    itemsGap.orientation = "column";
    itemsGap.alignChildren = ["center", "center"];
    itemsGap.spacing = 5;
    itemsGap.margins = 0;

    const itemsGap1 = itemsGap.add("statictext", undefined, undefined, { name: "itemsGap1" });
    itemsGap1.text = "Items Gap";
    itemsGap1.justify = "center";

    const itemsGapField = itemsGap.add('edittext {justify: "center", properties: {name: "itemsGapField"}}');
    itemsGapField.text = "0.1";
    itemsGapField.preferredSize.width = 70;

    itemsGapField.addEventListener("keydown", (event) => {
        const key = event.keyName; // Note: using 'key' instead of 'keyName' which is more standard

        if (event.keyName === "Escape") {
            dialogRoot.close();
            return;
        }

        // Allow numbers, backspace, delete, and decimal point
        // Also prevent multiple decimal points
        if (
            !/[0-9]/.test(key) &&
            key !== "Backspace" &&
            key !== "Delete" &&
            key !== "Decimal" &&
            key !== "Period"
        ) {
            event.preventDefault();
        }
        if (key === "Enter") {
            enterBn.notify()
        }
    });

    // REQUIREDPANEL
    // =============
    const requiredPanel = panelContGrp.add("panel", undefined, undefined, { name: "requiredPanel" });
    requiredPanel.text = "Sizes Info";
    requiredPanel.preferredSize.width = 200;
    requiredPanel.orientation = "column";
    requiredPanel.alignChildren = ["center", "top"];
    requiredPanel.spacing = 10;
    requiredPanel.margins = 10;

    // SIZECONTGRP
    // ===========
    const sizeContGrp = requiredPanel.add("group", undefined, { name: "sizeContGrp" });
    sizeContGrp.preferredSize.width = 100;
    sizeContGrp.orientation = "column";
    sizeContGrp.alignChildren = ["center", "center"];
    sizeContGrp.spacing = 5;
    sizeContGrp.margins = 0;

    const sizeContainer = sizeContGrp.add("statictext", undefined, undefined, { name: "sizeContainer" });
    sizeContainer.text = "Size Container";
    sizeContainer.justify = "center";

    const sizeContainerList_array = objectKeys(CONFIG.Size_Container);
    const currentSizeContainer = sizeContainerList_array[0];
    const sizeContainerList = sizeContGrp.add("dropdownlist", undefined, undefined, { name: "sizeContainerList", items: sizeContainerList_array });
    sizeContainerList.selection = 0;
    sizeContainerList.preferredSize.width = 70;
    sizeContainerList.alignment = ["center", "center"];
    const sizeList_array = objectKeys(CONFIG.Size_Container[currentSizeContainer]["MENS"]).concat(objectKeys(CONFIG.Size_Container[currentSizeContainer]["BABY"]));

    // TARGETSIZEGRP
    // =============
    const targetSizeGrp = requiredPanel.add("group", undefined, { name: "targetSizeGrp" });
    targetSizeGrp.preferredSize.width = 100;
    targetSizeGrp.orientation = "column";
    targetSizeGrp.alignChildren = ["center", "center"];
    targetSizeGrp.spacing = 5;
    targetSizeGrp.margins = 0;

    const targetSize = targetSizeGrp.add("statictext", undefined, undefined, { name: "targetSize" });
    targetSize.text = "Target Size";
    targetSize.justify = "center";

    const sizeList = targetSizeGrp.add("dropdownlist", undefined, undefined, { name: "sizeList", items: sizeList_array });
    sizeList.selection = 0;
    sizeList.preferredSize.width = 70;
    sizeList.alignment = ["center", "center"];

    sizeContainerList.onChange = () => {
        // Get the selected size container
        const currentSizeVal = sizeContainerList.selection.text;

        // Update the available sizes based on the selected container
        const currentSizeList_array = objectKeys(CONFIG.Size_Container[currentSizeVal]["MENS"]).concat(objectKeys(CONFIG.Size_Container[currentSizeContainer]["BABY"]));

        // Update the items in the target size dropdown
        sizeList.removeAll(); // Clear the current items in the dropdown

        for (const size of currentSizeList_array) {
            sizeList.add(`item`, size);
        }

        // Optionally reset the selection to the first item (or a default option)
        sizeList.selection = 0;
    };

    // QUANTITYGRP
    // ===========
    const quantityGrp = requiredPanel.add("group", undefined, { name: "quantityGrp" });
    quantityGrp.preferredSize.width = 100;
    quantityGrp.orientation = "column";
    quantityGrp.alignChildren = ["center", "center"];
    quantityGrp.spacing = 5;
    quantityGrp.margins = 0;

    const quantity = quantityGrp.add("statictext", undefined, undefined, { name: "quantity" });
    quantity.text = "Quantity";
    quantity.justify = "center";

    const quantityField = quantityGrp.add('edittext {justify: "center", properties: {name: "quantityField"}}');
    quantityField.text = "2";
    quantityField.preferredSize.width = 70;

    quantityField.addEventListener("keydown", digitValidateCb);

    // SIZEINCGRP
    // ==========
    const sizeIncGrp = requiredPanel.add("group", undefined, { name: "sizeIncGrp" });
    sizeIncGrp.enabled = false;
    sizeIncGrp.preferredSize.width = 100;
    sizeIncGrp.orientation = "column";
    sizeIncGrp.alignChildren = ["center", "center"];
    sizeIncGrp.spacing = 5;
    sizeIncGrp.margins = 0;

    const sizeInc = sizeIncGrp.add("statictext", undefined, undefined, { name: "sizeInc" });
    sizeInc.text = "Size++";
    sizeInc.justify = "center";

    const sizeincField = sizeIncGrp.add('edittext {justify: "center", properties: {name: "sizeincField"}}');
    sizeincField.text = "0";
    sizeincField.preferredSize.width = 70; 

    // ENTERBTNGRP
    // ===========
    const enterBtnGrp = dialogRoot.add("group", undefined, { name: "enterBtnGrp" });
    enterBtnGrp.orientation = "row";
    enterBtnGrp.alignChildren = ["left", "center"];
    enterBtnGrp.spacing = 10;
    enterBtnGrp.margins = 0;

    const enterBn = enterBtnGrp.add("button", undefined, "Start", { name: "ok" });
    enterBn.helpTip = "Start Action";
    enterBn.active = true;

    enterBn.onClick = () => {
        dialogRoot.close();
        function fixMultipleDots(str) {
            const parts = str.split('.');
            if (parts.length <= 2) {
                return parseFloat(str); // Already a valid float
            }

            // Join only the first two parts to make a valid float
            const fixedStr = parts[0] + '.' + parts[1];
            return parseFloat(fixedStr);
        }

        if (!quantityField.text || parseInt(quantityField.text) < 2) {
            alertDialogSA("Minimum quantity 2 required");
            return;
        }

        CONFIG.Items_Gap = itemsGapField.text ? fixMultipleDots(itemsGapField.text) : 0;
        CONFIG.perDoc = perDocField.text ? parseInt(perDocField.text) : 0;
        CONFIG.orientation = orientations.selection.text;
        dialogRoot.close(1); // success signal
    }

    // Show dialog and act on result
    const result = dialogRoot.show();

    if (result === 1) {
        gridMenuallyCB({
            mode: gridModeList.selection.text,
            quantity: quantityField.text ? parseInt(quantityField.text) : 0,
            sizeContainer: sizeContainerList.selection.text,
            targetSizeChr: sizeList.selection.text
        });
    }
}